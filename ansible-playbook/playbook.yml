- name: Add hosts to known_hosts file
  hosts: all

  tasks:
    - name: Add hosts to known_hosts
      known_hosts:
        path: ~/.ssh/known_hosts
        name: "{{ item }}"
        key: "{{ hostvars[item].ansible_host }}"
        key_options: "port=22"
      when: hostvars[item].ansible_host is defined
      loop: "{{ groups['nomad_servers'] + groups['nomad_clients'] }}"

- name: Ubuntu Server Setup
  hosts: all
  become: yes
  tasks:
    - name: Update all packages
      ansible.builtin.apt:
        update_cache: yes
        upgrade: dist

- name: Install necessary packages
    ansible.builtin.apt:
      name:
        - wget
        - gpg
        - curl
        - coreutils
        - jq
      state: present

- name: Set up UFW Firewall
    ansible.builtin.ufw:
      state: enabled
      default: deny
      direction: incoming
      rule: allow
      port: 22
    notify: restart sshd


handlers:
  - name: restart sshd
    ansible.builtin.service:
      name: sshd
      state: restarted